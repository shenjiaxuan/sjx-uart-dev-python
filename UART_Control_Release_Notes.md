# UART控制系统 Release Notes

## 版本 3.0.1 - 2025年7月3日

### 主要更新
- **SDK中间件对接**: 完成counting、parking、alarm、speed功能对接
- **日志系统**: 修改logger为全局变量
- **相机控制**: 不再实际关闭相机硬件，改为状态管理
- **PS命令优化**: 未使用相机发送空字典，优化串口发送逻辑
- **数据获取**: 修改画框和画线数据获取方式
- **OBdata修复**: 修复返回内容，使其更加合理
- **架构简化**: 移除webserver socket通信

---

## 版本 3.0.0 - 2025年

## 版本信息
- **模块名称**: uart_control.py
- **版本号**: 3.0.0
- **系统**: AglaiaSense智能交通监控系统
- **设备型号**: GS500
- **发布日期**: 2025年

## 系统概述

UART控制系统是AglaiaSense智能交通监控设备的核心通信模块，负责处理与外部系统的串口通信，协调摄像头数据采集、车辆检测计数、速度监测和紧急事件处理等功能。

## 主要功能特性

### 🔌 通信接口
- **UART串口通信**: 通过`/dev/ttymxc2`端口，波特率38400，支持双向数据传输
- **多Socket连接管理**: 自动维护与摄像头、DNN处理模块和CDS服务器的Socket连接
- **JSON格式数据交换**: 标准化的命令和响应格式

### 📹 双摄像头支持
- **灵活配置**: 支持左摄像头(cam1)、右摄像头(cam2)或双摄像头(dual)模式
- **共享内存访问**: 通过POSIX共享内存高效获取实时图像数据
- **图像压缩传输**: 自适应JPEG压缩，目标大小12.8KB，质量动态调整

### 🚗 智能交通检测
- **车辆分类计数**: 支持轿车、卡车、公交车、行人、自行车等多种目标检测
- **方向识别**: 区分进入(in)和离开(out)方向的交通流量
- **速度监测**: 实时计算并统计各类车辆的平均速度
- **双重速度算法**: 
  - 加权平均法: `(previous_average * count + new_speed) / (count + 1)`
  - 滑动平均法: `(current_average + new_speed) / 2`

### ⚠️ 紧急事件处理
- **CDS事件监听**: 实时接收交通违法和紧急事件警报
- **自动图像捕获**: 紧急模式触发时自动保存现场图像
- **应用模式切换**: 
  - 正常模式: AppNumber "699" (交通监控)
  - 紧急模式: AppNumber "698" (紧急事件)

### 🔧 设备管理
- **摄像头参数控制**: 增益、曝光、自动曝光(AE)、自动白平衡(AWB)调节
- **WiFi状态管理**: 支持WiFi开关控制和状态查询
- **错误诊断**: 实时监测摄像头状态和系统错误
- **配置文件管理**: 动态加载和更新系统配置

## 支持的UART命令

### 查询命令
| 命令 | 功能描述 | 响应格式 |
|------|----------|----------|
| `?Asset` | 查询设备资产信息 | JSON格式设备信息 |
| `?Order` | 查询设备订单信息 | JSON格式订单数据 |
| `?ERR` | 查询摄像头错误状态 | 错误代码和状态 |
| `?OBdata` | 获取检测数据 | 交通计数和速度数据 |
| `?PS[1-24]` | 查询特定参数或图像块 | 参数值或图像数据 |

### 设置命令
| 命令 | 功能描述 | 参数范围 |
|------|----------|----------|
| `@\|[频率]` | 设置数据上报频率 | 数值(秒) |
| `Profile\|[模式]` | 切换摄像头配置 | 1(左), 2(右), 3(双) |
| `WiFi\|[状态]` | WiFi开关控制 | 0(关闭), 1(开启) |
| `REACT\|` | 查询紧急模式状态 | - |

## 技术架构

### 🧵 多线程设计
- **主线程**: UART命令处理和响应
- **连接线程**: 自动维护Socket连接，支持断线重连
- **事件监听线程**: 异步处理CDS事件通知
- **速度数据线程**: 实时接收和处理速度测量数据

### 📊 数据处理流程
1. **图像采集**: 从共享内存读取摄像头原始图像
2. **数据获取**: 通过CDS接口获取检测计数和速度数据
3. **累积处理**: 计算周期内的增量计数值
4. **速度统计**: 基于配置的算法计算平均速度
5. **格式转换**: 将数据重新格式化为UART协议格式
6. **响应发送**: 通过串口发送JSON格式响应

### 🔐 错误处理机制
- **连接监控**: 自动检测Socket连接状态，断线时自动重连
- **异常捕获**: 全面的try-catch错误处理
- **日志记录**: 详细的调试和错误日志，支持日志轮转
- **资源管理**: 正确的内存和文件描述符管理

## 配置要求

### 系统依赖
- **操作系统**: Linux (支持POSIX共享内存)
- **Python版本**: Python 3.x
- **硬件接口**: UART串口设备(/dev/ttymxc2)

### 必需的Python包
```python
- socket          # 网络通信
- serial          # 串口通信
- PIL (Pillow)    # 图像处理
- numpy          # 数值计算
- posix_ipc      # POSIX IPC支持
- json           # JSON数据处理
- threading      # 多线程支持
```

### 配置文件
- **主配置**: `/home/root/AglaiaSense/resource/share_config/gs501.json`
- **诊断信息**: `/home/root/AglaiaSense/resource/share_config/diagnose_info_[1|2].json`

## 网络端口配置

### CDS服务器端口
- **左摄像头**: 
  - 命令端口: 7170
  - 事件端口: 7172  
  - 速度端口: 7173
- **右摄像头**:
  - 命令端口: 7171
  - 事件端口: 7181
  - 速度端口: 7182

### 摄像头服务端口
- **摄像头1**: CAMERA1_PORT, CAMERA1_DNN_PORT
- **摄像头2**: CAMERA2_PORT, CAMERA2_DNN_PORT

## 性能特性

### ⚡ 响应性能
- **UART响应时间**: < 100ms (典型值)
- **图像处理时间**: < 8ms (单次压缩)
- **数据更新频率**: 可配置 (默认300秒)

### 💾 资源使用
- **内存占用**: 动态管理，支持共享内存
- **日志管理**: 10MB轮转，保留3个备份文件
- **图像压缩**: 自适应质量调整，目标12.8KB

## 部署说明

### 启动要求
1. 确保UART设备可访问(`/dev/ttymxc2`)
2. 配置文件正确放置在指定路径
3. CDS服务器和摄像头服务正常运行
4. 共享内存资源可用

### 运行模式
```bash
python3 uart_control.py
```

### 日志位置
- **日志文件**: `./log/uart_log.txt`
- **临时图像**: `./tmp/`目录

## 已知限制

1. **系统重启**: 切换摄像头配置时需要重启系统
2. **连接依赖**: 依赖外部CDS服务器和摄像头服务的可用性
3. **平台限制**: 需要Linux环境和POSIX共享内存支持
4. **硬件要求**: 需要特定的UART接口配置

## 维护建议

### 📝 日常监控
- 监控日志文件大小和错误信息
- 检查Socket连接状态
- 验证数据上报的准确性

### 🔧 故障排除
- 检查UART设备权限和连接状态
- 验证配置文件格式和路径
- 确认网络端口可用性
- 监控系统资源使用情况

---

*本Release Note涵盖了UART控制系统的核心功能和技术细节。如有疑问或需要技术支持，请联系开发团队。* 