# UART控制系统 Release Notes

## 版本 3.2.3 - 2025年11月26日

### 主要更新
- **灵活图像块配置**: 新增 BLK 命令支持动态设置图像块数量（20-80块）
  - 新增 `BLK|xxx` 命令设置最大图像块数量
  - 支持运行时动态调整，无需重启
  - 持久化保存到 config.json，重启后自动恢复
  - ?PS 命令范围动态扩展：?ps5 到 ?ps(4+max_image_blocks)
  - 智能图片质量调整：根据块数量自动优化 JPEG 压缩质量

- **图像质量优化**: 实现自适应图像质量控制
  - target_size 根据 max_image_blocks 动态计算
  - 分段设置初始 JPEG quality（20-85）
  - 单摄模式支持更高质量（最高85）
  - 双摄模式优化质量平衡（最高80）

- **配置管理增强**: 更新 gs501.json 和 Order 命令
  - 更新 gs501.json 配置文件格式
  - 优化 Order 命令回复内容
  - 修复 AppNumber 值获取方式，提高可靠性

---

## 版本 3.2.2 - 2025年11月20日

### 主要更新
- **Counting数据获取优化**: 将counting数据获取方式从主动查询改为被动接收模式
  - 提高系统响应效率，减少主动轮询开销
  - 优化数据获取的实时性和准确性
- **SDK连接架构升级**: SDK通信链路改为长连接模式
  - 建立持久化的SDK连接，提高通信稳定性
  - 优化数据接收方式，提升数据传输效率
  - 减少频繁建立/断开连接的资源消耗
- **CDS格式同步**: 同步SDK的CDS数据格式变更
  - 保持与SDK中间件的数据格式一致性
  - 确保数据解析的正确性和兼容性
- **心跳机制调整**: 关闭SDK心跳机制
  - 优化系统资源使用
  - 简化连接管理逻辑

### 技术改进
- **通信模式优化**: 从短连接轮询改为长连接推送，提升整体性能
- **代码重构**: 大规模代码优化（157行新增，141行删除）
- **架构简化**: 简化连接管理，提高代码可维护性

---

## 版本 3.2.1 - 2025年10月13日

### 主要更新
- **SDK Token逻辑优化**: 改进SDK token管理机制和重连逻辑
  - 简化token锁机制，移除冗余的token_lock使用
  - 优化SDK登录/登出逻辑，确保token的全局一致性
  - SDK API函数不再负责token管理，统一由心跳线程维护
  - 改进心跳失败后的自动重登录机制
  - 心跳间隔从60秒优化为30秒，提高连接稳定性
  - 增强token失效时的错误处理和日志记录
- **ZIP包在线更新功能**: 新增通过UART传输ZIP包并自动更新系统的功能
  - 支持接收和保存ZIP更新包到指定目录
  - 实现自动更新脚本执行机制
  - 更新完成后自动清理标志位
  - 支持通过socket通知进行更新操作
  - 增强更新过程的错误处理和日志记录
- **二进制文件传输**: 新增完整的文件传输协议支持
  - 实现基于UART的可靠文件传输协议
  - 支持大文件分块传输（默认128字节/块）
  - 支持断点续传和重传机制
  - 新增CRC校验确保传输完整性
  - 提供独立的文件发送工具 `send_file_uart.py`
  - 详细的协议文档 `PROTOCOL_SPECIFICATION.md`
- **标志位清除逻辑优化**: 改进系统标志位的清除机制
  - 优化清除标志位的时机和逻辑
  - 提高系统状态管理的可靠性

### 技术改进
- **连接管理增强**: SDK连接更加稳定，自动重连机制更加可靠
- **文件传输协议**: 新增完整的二进制文件传输层，支持各类文件传输
- **系统更新能力**: 支持远程在线更新，无需物理接触设备
- **代码质量提升**: 移除冗余的锁机制，提高代码执行效率

### 新增文件
- `send_file_uart.py`: UART文件传输工具
- `test_file_transfer.py`: 文件传输测试工具
- `FILE_TRANSFER_README.md`: 文件传输功能使用说明
- `PROTOCOL_SPECIFICATION.md`: 详细的通信协议规范文档

---

## 版本 3.0.3 - 2025年8月26日

### 主要更新
- **WiFi控制API对接**: 完成WiFi状态管理与SDK中间件的API对接
  - 新增 `sdk_get_hardware_status()` 函数获取硬件状态
  - 新增 `sdk_set_hardware_status()` 函数设置硬件状态
  - 新增 `get_wifi_status_from_sdk()` 和 `set_wifi_status_via_sdk()` 函数
  - WiFi控制命令支持通过SDK进行状态管理
  - **启用WiFi的SDK控制功能**，提供更稳定的WiFi状态管理
- **Camera Settings API对接**: 摄像头参数获取完全对接SDK API
  - 新增 `sdk_get_camera_param()` 函数获取摄像头参数
  - PS1/PS2命令现在通过SDK获取实时摄像头参数（增益、曝光、AE模式、帧率、gamma等）
  - 摄像头参数获取支持左右摄像头独立配置
- **代码清理和优化**: 移除不再使用的代码和文件
  - 移除过时的webserver socket通信相关代码
  - 清理无效的文件和冗余代码
  - 优化代码结构，提高系统稳定性
- **Cython打包功能**: 新增Cython编译打包支持
  - 支持将Python代码编译为二进制文件，提高代码执行效率
  - 增强代码安全性，保护源代码不被直接查看
  - 优化系统启动速度和运行性能

### 技术改进
- **SDK集成增强**: 完善SDK中间件集成，支持更多硬件控制功能
- **参数获取实时化**: 摄像头参数获取从静态配置改为实时SDK查询
- **错误处理优化**: 增强SDK API调用的错误处理和日志记录

---

## 版本 3.0.1 - 2025年7月3日

### 主要更新
- **SDK中间件对接**: 完成counting、parking、alarm、speed功能对接
- **日志系统**: 修改logger为全局变量
- **相机控制**: 不再实际关闭相机硬件，改为状态管理
- **PS命令优化**: 未使用相机发送空字典，优化串口发送逻辑
- **数据获取**: 修改画框和画线数据获取方式
- **OBdata修复**: 修复返回内容，使其更加合理
- **架构简化**: 移除webserver socket通信

### Bug修复 - 2025年7月5日
- **线类型检测优化**: 修复两条线类型不一致时的异常处理
- **相机控制逻辑**: 修复相机控制相关的逻辑问题
- **计数数据获取**: 修复正确获取counting数据的类型识别

---

## 版本 3.0.0 - 2025年

## 版本信息
- **模块名称**: uart_control.py
- **版本号**: 3.0.0
- **系统**: AglaiaSense智能交通监控系统
- **设备型号**: GS500
- **发布日期**: 2025年

## 系统概述

UART控制系统是AglaiaSense智能交通监控设备的核心通信模块，负责处理与外部系统的串口通信，协调摄像头数据采集、车辆检测计数、速度监测和紧急事件处理等功能。

## 主要功能特性

### 🔌 通信接口
- **UART串口通信**: 通过`/dev/ttymxc2`端口，波特率38400，支持双向数据传输
- **多Socket连接管理**: 自动维护与摄像头、DNN处理模块和CDS服务器的Socket连接
- **JSON格式数据交换**: 标准化的命令和响应格式

### 📹 双摄像头支持
- **灵活配置**: 支持左摄像头(cam1)、右摄像头(cam2)或双摄像头(dual)模式
- **共享内存访问**: 通过POSIX共享内存高效获取实时图像数据
- **图像压缩传输**: 自适应JPEG压缩，目标大小12.8KB，质量动态调整

### 🚗 智能交通检测
- **车辆分类计数**: 支持轿车、卡车、公交车、行人、自行车等多种目标检测
- **方向识别**: 区分进入(in)和离开(out)方向的交通流量
- **速度监测**: 实时计算并统计各类车辆的平均速度
- **双重速度算法**: 
  - 加权平均法: `(previous_average * count + new_speed) / (count + 1)`
  - 滑动平均法: `(current_average + new_speed) / 2`

### ⚠️ 紧急事件处理
- **CDS事件监听**: 实时接收交通违法和紧急事件警报
- **自动图像捕获**: 紧急模式触发时自动保存现场图像
- **应用模式切换**: 
  - 正常模式: AppNumber "699" (交通监控)
  - 紧急模式: AppNumber "698" (紧急事件)

### 🔧 设备管理
- **摄像头参数控制**: 通过SDK API实时获取和控制增益、曝光、自动曝光(AE)、帧率、gamma等参数
- **WiFi状态管理**: 支持通过SDK中间件进行WiFi开关控制和状态查询
- **硬件状态监控**: 通过SDK获取完整的硬件状态信息
- **错误诊断**: 实时监测摄像头状态和系统错误
- **配置文件管理**: 动态加载和更新系统配置

## 支持的UART命令

### 查询命令
| 命令 | 功能描述 | 响应格式 |
|------|----------|----------|
| `?Asset` | 查询设备资产信息 | JSON格式设备信息 |
| `?Order` | 查询设备订单信息 | JSON格式订单数据 |
| `?ERR` | 查询摄像头错误状态 | 错误代码和状态 |
| `?OBdata` | 获取检测数据 | 交通计数和速度数据 |
| `?PS[1-84]` | 查询特定参数或图像块 | 参数值或图像数据（动态范围）|
| `BLK\|` | 查询当前图像块配置 | {"TotalImageBlocks": "20"} |

### 设置命令
| 命令 | 功能描述 | 参数范围 |
|------|----------|----------|
| `@\|[频率]` | 设置数据上报频率 | 数值(秒) |
| `Profile\|[模式]` | 切换摄像头配置 | 1(左), 2(右), 3(双) |
| `WiFi\|[状态]` | WiFi开关控制 | 0(关闭), 1(开启) |
| `REACT\|` | 查询紧急模式状态 | - |
| `BLK\|[块数]` | 设置最大图像块数量 | 20-80，自动限制范围 |

## 技术架构

### 🧵 多线程设计
- **主线程**: UART命令处理和响应
- **连接线程**: 自动维护Socket连接，支持断线重连
- **事件监听线程**: 异步处理CDS事件通知
- **速度数据线程**: 实时接收和处理速度测量数据
- **SDK心跳线程**: 维护与SDK中间件的连接状态
- **事件服务器线程**: 接收来自SDK的事件数据

### 📊 数据处理流程
1. **图像采集**: 从共享内存读取摄像头原始图像
2. **数据获取**: 通过CDS接口获取检测计数和速度数据
3. **累积处理**: 计算周期内的增量计数值
4. **速度统计**: 基于配置的算法计算平均速度
5. **格式转换**: 将数据重新格式化为UART协议格式
6. **响应发送**: 通过串口发送JSON格式响应

### 🔐 错误处理机制
- **连接监控**: 自动检测Socket连接状态，断线时自动重连
- **异常捕获**: 全面的try-catch错误处理
- **日志记录**: 详细的调试和错误日志，支持日志轮转
- **资源管理**: 正确的内存和文件描述符管理

## 配置要求

### 系统依赖
- **操作系统**: Linux (支持POSIX共享内存)
- **Python版本**: Python 3.x
- **硬件接口**: UART串口设备(/dev/ttymxc2)

### 必需的Python包
```python
- socket          # 网络通信
- serial          # 串口通信
- PIL (Pillow)    # 图像处理
- numpy          # 数值计算
- posix_ipc      # POSIX IPC支持
- json           # JSON数据处理
- threading      # 多线程支持
- subprocess      # 系统命令执行
- logging         # 日志记录
```

### 配置文件
- **主配置**: `/home/root/AglaiaSense/resource/share_config/gs501.json`
- **诊断信息**: `/home/root/AglaiaSense/resource/share_config/diagnose_info_[1|2].json`

## 网络端口配置

### SDK中间件端口
- **SDK JSON通信**: 1880
- **事件服务器**: 1780 (接收SDK事件数据)

### CDS服务器端口
- **左摄像头**: 
  - 命令端口: 7170
  - 事件端口: 7172  
  - 速度端口: 7173
- **右摄像头**:
  - 命令端口: 7171
  - 事件端口: 7181
  - 速度端口: 7182

### 摄像头服务端口
- **摄像头1**: 10808
- **摄像头2**: 10809

## 性能特性

### ⚡ 响应性能
- **UART响应时间**: < 100ms (典型值)
- **图像处理时间**: < 8ms (单次压缩)
- **数据更新频率**: 可配置 (默认300秒)

### 💾 资源使用
- **内存占用**: 动态管理，支持共享内存
- **日志管理**: 10MB轮转，保留3个备份文件
- **图像压缩**: 自适应质量调整，目标12.8KB

## 部署说明

### 启动要求
1. 确保UART设备可访问(`/dev/ttymxc2`)
2. 配置文件正确放置在指定路径
3. CDS服务器和摄像头服务正常运行
4. 共享内存资源可用

### 运行模式
```bash
python3 uart_control.py
```

### 日志位置
- **日志文件**: `./log/uart_log.txt`
- **临时图像**: `./tmp/`目录

## 已知限制

1. **系统重启**: 切换摄像头配置时需要重启系统
2. **连接依赖**: 依赖外部CDS服务器和摄像头服务的可用性
3. **平台限制**: 需要Linux环境和POSIX共享内存支持
4. **硬件要求**: 需要特定的UART接口配置

## 维护建议

### 📝 日常监控
- 监控日志文件大小和错误信息
- 检查Socket连接状态
- 验证数据上报的准确性

### 🔧 故障排除
- 检查UART设备权限和连接状态
- 验证配置文件格式和路径
- 确认网络端口可用性
- 监控系统资源使用情况

---

*本Release Note涵盖了UART控制系统的核心功能和技术细节。如有疑问或需要技术支持，请联系开发团队。* 